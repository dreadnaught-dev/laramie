"use strict";var handlebarsTemplates=[],filterIndex=1,quickSearchTimeout=null;function addFilter(e){(e=e||{}).filterIndex=filterIndex,filterIndex+=1;var t=handlebarsTemplates["list-filter"],l=$(t(e));return $("#filters").append(l),$("#main-list-table").trigger("reflow"),l}function updateBulkActionState(){var e=0<$("#main-list-table .js-item-id:checked").length;$("#bulk-action-operation").attr("disabled",!e)}function loadHandlebarsTemplates(e){$('script[type="text/x-handlebars-template"]').each(function(e,t){var l=$(t);handlebarsTemplates[l.attr("id")]=Handlebars.compile(l.html())})}function loadFilters(){if(0!=$("#filter-holder").length){0<globals.filters.length&&$("#filter-holder").show();for(var e=0;e<globals.filters.length;e++){var t=globals.filters[e],l=addFilter();l.find('[name$="field"]').val(t.field),l.find('[name$="operation"]').val(t.operation),l.find('[name$="value"]').val(t.value)}}}$(document).ready(function(){loadHandlebarsTemplates(),loadFilters(),window.onblur=function(){$("#bulk-action-operation").val("")},$(".js-toggle-page-settings").on("click",function(){$("#page-settings").toggleClass("is-active"),$.event.trigger("modal-change")}),dragula([$("#selectable-fields")[0]]),$(".js-toggle-save-report").on("click",function(){$("#save-report-modal").toggleClass("is-active"),$.event.trigger("modal-change")}),$(".js-clear-search").on("click",function(e){$("#quick-search").val(""),$(e.target).closest("form").submit()}),$("#save-report-form").submit(function(e){var t=$(e.target);if(!(t.find("#modal-report-name").val()||"").trim())return alert("You must provide a report name."),!1;$("#is-filtering").val("");var l=$("#list-form");return l.attr("method","post").attr("action",l.data("saveReportAction")).append($('<div style="display:none"></div>').append(t.find(":input").clone())).submit(),!1}),$("#save-list-prefs-form").submit(function(e){$("#is-filtering").val("");var t=$("#list-form");return t.attr("method","post").attr("action",t.data("saveListPrefsAction")).append($('<div style="display:none"></div>').append($(e.target).find(":input").clone())).submit(),!1}),window.addEventListener("popstate",function(e){$("#quick-search").blur().val(""),e.state&&e.state.isFromJs&&$("#quick-search").val(e.state.quickSearch),$.get(document.location,function(e){$("#list-table-wrapper").replaceWith(e)})}),$("#quick-search").on("keyup",function(e){clearTimeout(quickSearchTimeout),quickSearchTimeout=setTimeout(function(){var e=$("#list-form").find(":input:not(.post-only)").serialize(),t=location.href.replace(/[?].*$/,"")+"?"+e;$.get(t,function(e){$("#list-table-wrapper").replaceWith(e)}),history.pushState&&window.history.pushState({isFromJs:1,path:t,quickSearch:$("#quick-search").val()},"",t)},250)}),$(document).on("keyup keydown",function(e){globals.isShiftDetected=e.shiftKey}),$(".js-select-all, .js-item-id").click(function(e){var t=$(e.target),l=t.is(":checked");if(t.is(".js-select-all"))$("#main-list-table .js-item-id:not([disabled])").prop("checked",l).trigger("change");else if(l){if(l){var i=t.closest("tr");if(globals.lastRowSelected&&globals.isShiftDetected)for(var a=$("#main-list-table tbody tr"),r=a.index(i),s=a.index(globals.lastRowSelected),o=a.index(i);o!=a.index(globals.lastRowSelected);o+=r<=s?1:-1)a.eq(o).find(".js-item-id").prop("checked",!0);globals.lastRowSelected=i}}else $(".js-select-all").prop("checked",!1);var n=$(".js-select-all").is(":checked")||$(".js-item-id").length==$(".js-item-id:checked").length;n&&"1"==$("#bulk-action-helper").data("hasAdditionalPages")?($(".js-select-all").prop("checked",!0),$("#bulk-action-helper").show()):n?$("#bulk-action-all-selected").val("1"):($("#bulk-action-helper").hide().removeClass("all-selected"),$("#bulk-action-all-selected").val("")),$("#main-list-table").trigger("reflow"),updateBulkActionState()}),$("#list-form").submit(function(e){"1"==$("#is-filtering").val()&&$(e.target).find(".post-only").remove()}),$(".js-delete").click(function(e){if(confirm("Delete this item?")){var t=$(e.target),l=t.closest("tr");$.post(t.data("action"),{_method:"DELETE"},function(e){e.success?(l.remove(),["viewing-end","viewing-total"].forEach(function(e){$("#"+e).text((Number($("#"+e).text())||1)-1)})):alert(e.message)})}}),$(".js-bulk-select-all").click(function(){$("#bulk-action-helper").addClass("all-selected"),$("#bulk-action-all-selected").val("1")}),$(".js-clear-bulk-selection").click(function(){$("#bulk-action-helper").removeClass("all-selected"),$("#bulk-action-all-selected").val(""),$(".js-select-all").trigger("click")}),$("#bulk-action-operation").change(function(e){var t=$(e.target).val().toLowerCase().replace(/\([^\)]+\)/,"").trim();if(t)if(confirm("Are you sure you want to "+t+" these items?")){$("#is-filtering").val("");var l=$("#list-form");l.attr("method","post").attr("action",l.data("bulkAction")).submit()}else $("#bulk-action-operation").val("");return!1}),$(".js-advanced-search").click(function(){$("#filter-holder").toggle(),$("#filter-holder").is(":visible")&&0==$(".filter-set").length&&addFilter()}),$("#filter-holder").on("click.add-filter",".js-add-filter",addFilter),$("#filters").on("click.remove-filter",".js-remove-filter",function(e){$(e.target).closest(".filter-set").remove(),$("#main-list-table").trigger("reflow"),0==$("#filters > .filter-set").length&&$("#filter-holder").hide(),0<globals.filters.length&&0==$("#filters > .filter-set").length&&$("#list-form").submit()}),$(".js-set-default-report").click(function(e){confirm("Use this report as default view for this page?")&&($.post($(e.target).data("action")),$("#page-settings").removeClass("is-active"),$.event.trigger("modal-change"))}),$(".js-delete-report").click(function(e){var t=$(e.target);confirm("Delete this saved report?")&&($.post(t.data("action")),t.closest(".field").remove(),$("#page-settings").removeClass("is-active"),$.event.trigger("modal-change"))}),$("#filters").on("click.remove-filter",".js-remove-filter",function(e){$(e.target).closest(".filter-set").remove(),$("#main-list-table").trigger("reflow"),0<globals.filters.length&&0==$("#filters > .filter-set").length&&$("#list-form").submit()}),$(".js-meta").on("click",function(e){var t=$(e.target);if($("#meta-modal-wrapper").toggleClass("is-active"),$.event.trigger("modal-change"),$("#meta-modal-wrapper").hasClass("is-active")){var l=t.closest(".has-invisibles").find(".js-item-id:checkbox").val();loadMeta(l)}}),$(document).on("meta-change",function(e,t){$("#row-"+t.id+" .tag-count").text(t.meta.tags.length),$("#row-"+t.id+" .comment-count").text(t.meta.comments.length)})});