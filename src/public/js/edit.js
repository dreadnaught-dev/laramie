var timer,handlebarsTemplates=[],wysiwygEditors={},initSaveBoxOffset=100;function dynamicFileHref(e){var a=$(e).text().trim(),t=/\.(gif|jpg|jpeg|png)$/i.test(a),n=$(e).closest("label").find("input:checkbox").val();return!!n&&($(e).attr("href",(t?globals.cropperBase:globals.fileDownloadBase)+n),!0)}function randString(e){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";e=e||10;for(var t=[],n=0;n<e;n++)t.push(a.charAt(Math.floor(Math.random()*a.length)));return t.join("")}function doSearch(t){var e=(t.closest(".reference-wrapper").find(".reference-ids").val()||"").split(/[|,]/g),a=(t.find(":input:checked").each(function(){e.push($(this).val())}),t.find(".keywords").val()),n=t.data("lookupSubtype"),i="1"==t.data("isSingleReference"),r=t.data("field");$.getJSON(globals.adminUrl+"/ajax/"+t.data("type")+"/"+t.data("lookupType"),{selectedItems:e.join("|"),keywords:a,lookupSubtype:n,itemId:globals.metaId,field:r},function(e){t.find(".js-select-reference").removeClass("is-loading"),t.find(".panel-block.option").remove();var a=handlebarsTemplates["reference-"+(i?"single":"many")+"-option"];t.find(".panel-block.search").after(a(e))})}function loadHandlebarsTemplates(e){$('script[type="text/x-handlebars-template"]').each(function(){var e=$(this);handlebarsTemplates[e.attr("id")]=Handlebars.compile(e.html())})}function loadAggregateFields(e,a,t,n){if(n=!!n,e.find(".js-temporary").remove(),!n&&"1"==e.data("processed"))return!0;var i=e.data("template"),r=e.data("type"),s="1"==e.data("isRepeatable"),o=objectGet(a,r,s?[]:{}),l=handlebarsTemplates[i];if(t=$.extend({},t||{}),e.data("keys",$.extend({},t)),o&&s){for(var d=n?1:Math.max(o.length,e.data("minItems")),c=0;c<d;c++){var f=c<o.length?o[c]:{};t[r+"Key"]=f._key||getKey(),$newItem=$(l(t)),e.append($newItem),loadAggregateFieldsHelper(f,$newItem),e.find(".aggregate-holder").each(function(){loadAggregateFields($(this),f,t)})}if(0==d&&e.append('<p class="js-temporary">'+e.data("emptyMessage")+"</p>"),!n){var m=dragula([e[0]],{moves:function(e,a,t){return t.classList.contains("drag-"+r)}});m.on("drag",function(){e.children(".media").addClass("shrink-for-move")}),m.on("dragend",function(){e.children(".media").removeClass("shrink-for-move")})}}else o&&(t[r+"Key"]=o._key||getKey(),$newItem=$(l(t)),e.append($newItem),loadAggregateFieldsHelper(o,$newItem),e.find(".aggregate-holder").each(function(){loadAggregateFields($(this),o,t)}));e.data("processed","1")}function loadAggregateFieldsHelper(e,a){for(var t in e){var n=e[t];if(null!==n){var i=a.find('[data-field-key="'+t+'"]');switch(i.data("fieldType")){case"file":i.find("[name$="+t+"]:checkbox").closest(".file-wrapper").addClass("has-file").find("[name$="+t+"]:checkbox").prop("checked",!0).val(n.uploadKey).parent().find(".js-file-name").html('<img class="filetype-icon" src="'+globals.adminUrl+"/assets/icon/"+n.uploadKey+'_50">'+n.name);break;case"password":i.find(".password-wrapper").addClass("has-password").find("[name$="+t+"]:checkbox").prop("checked",!0).val(n.encryptedValue);break;case"timestamp":i.find("[name$="+t+"-date]").val(n.date),i.find("[name$="+t+"-time]").val(n.time),i.find("[name$="+t+"-timezone]").val(n.timezone);break;case"markdown":i.find("[name$="+t+"]").val(n.markdown).closest(".columns").find(".markdown-html").html(n.html);break;case"checkbox":i.find("[name$="+t+"]:checkbox").prop("checked",n);break;case"boolean":i.find("[id$="+t+"-"+(n?"yes":"no")+"]").prop("checked",!0);break;case"radio":for(var r=i.find(":radio").toArray(),s=0,o=!1;s<r.length&&!o;s++){var l=$(r[s]);l.val()==n&&(o=!0,l.prop("checked",!0))}break;case"reference":var d=(Array.isArray(n)?n:[n]).filter(function(e){return!!e&&null!==e.id});i.find("[name$="+t+"]").val(d.map(function(e){return e.id}).join("|")),0<d.length&&i.find(".selection-info").html(d.map(function(e){return'<em><a href="'+i.find(".selection-info").data("baseUrl").replace(/new$/,e.id)+'?is-child=1" target="_blank">'+e._alias+"</a></em>"}).join(", "));break;case"select":if(Array.isArray(n))for(s=0;s<n.length;s++)i.find("[name$="+t+'\\[\\]] option[value="'+n[s]+'"]').prop("selected",!0);else i.find("[name$="+t+"]").val(n);i.find("[name$="+t+"\\[\\]]").trigger("change");break;default:i.find("[name$="+t+"]").val(n).trigger("change")}}}}function defaultEmptyTimezonesToBrowserValue(){$(".timezone-timestamp").each(function(){$timezone=$(this),$timezone.val()||$timezone.val(Intl.DateTimeFormat().resolvedOptions().timeZone)})}function resetFormSerialization(){globals.serializedEditForm=$("#edit-form").serialize()}function transformSelectsToSelect2(){$("select[multiple]:not(.select2-hidden-accessible), select.select2:not(.select2-hidden-accessible)").select2()}function loadReferences(){$(".reference-panel").each(function(){var e=$(this);doInvertedSearch(e),e.find(".keywords").keyup(debounce(function(){doInvertedSearch(e)},500))})}function doInvertedSearch(t){var e=t.find(".keywords").val();$.getJSON(globals.adminUrl+"/ajax/"+t.data("type")+"/"+t.data("lookupType"),{keywords:e,itemId:globals.metaId,field:t.data("field"),invertSearch:!0},function(e){t.find(".js-select-reference").removeClass("is-loading"),t.find("tbody tr").remove();var a=handlebarsTemplates["inverted-reference-option"];t.find("tbody").append(a(e))})}function getKey(){return randString()}function objectGet(e,a,t){try{for(var n=0,i=(a=a.split(".")).length;n<i;n++)e=e[a[n]];return void 0!==e?e:t}catch(e){return t}}function hasProperty(e,a){return null!==e&&"object"==typeof e&&e.hasOwnProperty(a)}function debounce(n,i,r){var s;return function(){var e=this,a=arguments,t=r&&!s;clearTimeout(s),s=setTimeout(function(){s=null,r||n.apply(e,a)},i),t&&n.apply(e,a)}}$(window).scroll(function(){clearTimeout(timer),timer=setTimeout(function(){var e=$(window).scrollTop(),a=$(".save-box").hasClass("is-pinned");initSaveBoxOffset<=e&&!a?$(".save-box").addClass("is-pinned"):e<initSaveBoxOffset&&a&&$(".save-box").removeClass("is-pinned")},50)}),$(document).ready(function(){loadHandlebarsTemplates(),$(".edit-container").find(".aggregate-holder").each(function(){var e=$(this).closest(".edit-container").data("itemId");loadAggregateFields($(this),objectGet(window,"globals.aggregates."+e,{})),$.event.trigger("aggregates-loaded")}),resetFormSerialization(),$(document).on("aggregates-loaded",resetFormSerialization),$(window).bind("beforeunload",function(){if(!globals.isSubmitting&&globals.serializedEditForm!=$("#edit-form").serialize())return"Cancel edit? Any unsaved changes will be lost."}),$("trix-editor").each(function(){this.editor.loadHTML(this.editor.element.value)}),$("#edit-tabs a").on("click",function(){$("#edit-tabs li").removeClass("is-active"),$(this).closest("li").addClass("is-active");var e=$(this).data("tab"),a="_main"!==e;$("#edit-form").toggleClass("has-tab-selected",a),$('[name="_selectedTab"]').val(e),$(".aggregate-outer-wrapper").removeClass("is-active"),a&&$(".aggregate-outer-wrapper.tab-"+e).addClass("is-active")});var t=globals.errorMessages||{};Object.keys(t).forEach(function(e){if(/[_]/.test(e)){var a=$('[name="'+e+'"]').closest(".field");a.toggleClass("is-danger",!0),t[e].forEach(function(e){a.append('<p class="help is-danger">'+e+"</p>")})}}),0<$("#edit-tabs").length&&$(".field.is-danger").each(function(){var e=$(this).closest(".is-tab");if(e.length)for(var a=e.attr("class").split(/\s+/),t=0;t<a.length;t++)/^tab-/.test(a[t])&&$('#edit-tabs [data-tab="'+a[t].replace(/^tab\-/,"")+'"]').toggleClass("is-danger",!0);else $('#edit-tabs [data-tab="_main"]').toggleClass("is-danger",!0)}),$("#edit-form").on("click.toggle-reference-search",".js-toggle-reference-search",function(){$searchWrapper=$(this).closest(".reference-wrapper").find(".reference-search"),$searchWrapper.toggle(),$searchWrapper.data("loaded")||($searchWrapper.data("loaded",!0),doSearch($searchWrapper),$searchWrapper.find(".keywords").keyup(debounce(function(){$searchWrapper.find(".js-select-reference").addClass("is-loading"),doSearch($searchWrapper)},500)))}),$(".js-toggle-prefs").on("click",function(){$(this).toggleClass("open").closest(".card").children(".card-content").toggleClass("is-hidden");var e=$("#tags-card-content").hasClass("is-hidden")?"1":"0",a=$("#revisions-card-content").hasClass("is-hidden")?"1":"0";$.post(globals.adminUrl+"/ajax/edit-prefs",{hideTags:e,hideRevisions:a})}),$("#edit-form").on("click.clear-reference-selection",".js-clear-reference-select",function(){$(this).closest(".reference-wrapper").find(":input:checked").prop("checked",!1),$(this).parent().find(".js-select-reference").trigger("click")}),$("#edit-form").on("keyup.update-markdown",".markdown",debounce(function(){var a=$(this);a.closest(".columns").find(".markdown-html").is(":visible")&&$.post(globals.adminUrl+"/ajax/markdown",{markdown:a.val()},function(e){a.closest(".columns").find(".markdown-html").html(e.html)})},300)),$(document).on("click.preview-markdown",".js-preview-markdown",function(e){var a=$("#markdown-preview-modal").find(".content").html("Loading...").end().toggleClass("is-active"),t=$(e.target).closest(".columns").find("textarea");$.post(globals.adminUrl+"/ajax/markdown",{markdown:t.val()},function(e){a.find(".content").html(e.html)})}),$(".js-compare-revisions").on("click",function(){return $("#revision-diff").html("Loading..."),$("#revisions-modal").toggleClass("is-active"),$.event.trigger("modal-change"),$("#revision-diff").load($(this).attr("href")),!1}),$(".js-hide-modal").on("click",function(){$(".modal.is-active").toggleClass("is-active",!1),$.event.trigger("modal-change")}),$("#edit-form").on("click.now-timestamp",".js-set-timestamp-now",function(e){var a=new Date,t=String(a.getFullYear()),n=String(a.getMonth()+1).padStart(2,"0"),i=String(a.getDate()).padStart(2,"0"),r=String(a.getHours()).padStart(2,"0"),s=String(a.getMinutes()).padStart(2,"0"),o=[t,n,i].join("-"),l=[r,s,"00"].join(":");$field=$(this).closest(".field"),$field.find('[name$="-date"]').val(o),$field.find('[name$="-time"]').val(l),$field.find('[name$="-timestamp"]').val(Intl.DateTimeFormat().resolvedOptions().timeZone)}),$("#edit-form").on("click.now-timestamp",".js-clear-timestamp",function(e){$field=$(this).closest(".field"),$field.find('[name$="-date"]').val(""),$field.find('[name$="-time"]').val("")}),$("#edit-form").on("click.add-aggregate",".js-add-aggregate",function(e){var a=$(e.target).parent().next(),t=a.data("keys"),n=a.children(".media").length;0<a.data("maxItems")&&n>=a.data("maxItems")?alert("You have maxed out the number of items you may add"):(loadAggregateFields(a,{},t,!0),defaultEmptyTimezonesToBrowserValue(),transformSelectsToSelect2())}),$("#edit-form").on("click.remove-aggregate",".js-remove-aggregate",function(e){var a=$(e.target),t=a.closest(".media"),n=a.closest(".aggregate-holder"),i=n.children(".media").length,r=n.data("minItems");i<=r?alert("You may not remove this item -- you must have at least "+r):(confirm("Remove this item?")&&t.remove(),0==n.children().length&&n.append('<p class="js-temporary">'+n.data("emptyMessage")+"</p>"))}),$("#edit-form").on("click.select-reference",".js-select-reference",function(){var a=$(this).hasClass("is-file-select"),t=$(this).closest(".reference-wrapper"),e=t.find(".reference-search"),n=e.find(":input:checked").toArray(),i=t.find("input.reference-ids").val(n.map(function(e){return $(e).val()}).join("|"));a&&i.prop("checked",!0);var r="Nothing selected";0<n.length&&(r=n.map(function(e){return'<em><a href="'+t.find(".selection-info").data("baseUrl").replace(/new$/,$(e).val())+'"'+(a?' onclick="dynamicFileHref(this)"':"")+' target="_blank">'+$(e).data("label")+"</a></em>"}).join(", ")),t.toggleClass("has-file",0<n.length).find(".selection-info").html(r).end().find(".hide-when-file").hide(),e.toggle(!1)}),$(".js-dismissable").click(function(){$(this).closest(".dismissable-wrapper").hide()}),$("#edit-form").submit(function(){globals.isSubmitting=!0}),$(".js-save").click(function(){$("#edit-form").submit()}),$(".js-delete").click(function(){confirm("Delete this item?")&&$("#delete-form").submit()}),$(".js-delete-revision").click(function(){confirm("Delete this revision?")&&($link=$(this),$.post($link.attr("href"),function(e){$link.closest(".revision-item").hide()}))}),$(".js-restore-revision").click(function(){confirm("Restore this revision? Any unsaved changes will be lost.")&&$(this).closest(".revision-item").find(".restore-revision-form").submit()}),$("a.show-more-link").click(function(){$(this).closest(".revision-history").toggleClass("show-more",!0)}),$("a.show-less-link").click(function(){$(this).closest(".revision-history").toggleClass("show-more",!1)}),loadMeta(globals.metaId,function(){var e=getQS(location.search);e["highlight-comment"]&&($("#comment-"+e["highlight-comment"]).addClass("is-highlighted"),$("html, body").animate({scrollTop:$("#comment-"+e["highlight-comment"]).offset().top-300},150))}),defaultEmptyTimezonesToBrowserValue(),transformSelectsToSelect2(),loadReferences(),$(document).on("change.change-inverted-ref","select.inverted-ref",function(e){$panel=$(e.target).closest(".reference-panel"),$.post(globals.adminUrl+"/ajax/modify-ref/"+$panel.data("lookupType"),{itemId:$(e.target).data("id"),field:$panel.data("field"),referenceId:globals.metaId,selected:$(e.target).val()},function(e){console.log(e)})})});