"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var timer,handlebarsTemplates=[],wysiwygEditors={},initSaveBoxOffset=100;function dynamicFileHref(e){var t=$(e).text().trim(),a=/\.(gif|jpg|jpeg|png)$/i.test(t),n=$(e).closest("label").find("input:checkbox").val();return!!n&&($(e).attr("href",(a?globals.cropperBase:globals.fileDownloadBase)+n),!0)}function randString(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";e=e||10;for(var a=[],n=0;n<e;n++)a.push(t.charAt(Math.floor(Math.random()*t.length)));return a.join("")}function doSearch(a){var n=(a.closest(".reference-wrapper").find(".reference-ids").val()||"").split(/[|,]/g),e=(a.find(":input:checked").each(function(e,t){n.push($(t).val())}),a.find(".keywords").val()),t=a.data("lookupSubtype"),i="1"==a.data("isSingleReference"),r=a.data("field");$.getJSON(globals.adminUrl+"/ajax/"+a.data("type")+"/"+a.data("lookupType"),{selectedItems:n.join("|"),keywords:e,lookupSubtype:t,itemId:globals.metaId,field:r},function(e){var t=handlebarsTemplates["reference-"+(i?"single":"many")+"-option"];a.find(".js-select-reference").removeClass("is-loading"),a.find(".results").empty().append(t(e))})}function loadHandlebarsTemplates(e){$('script[type="text/x-handlebars-template"]').each(function(e,t){var a=$(t);handlebarsTemplates[a.attr("id")]=Handlebars.compile(a.html())})}function loadAggregateFields(e,t,a,n){if(n=!!n,e.find(".js-temporary").remove(),!n&&"1"==e.data("processed"))return!0;var i=e.data("template"),r=e.data("type"),o="1"==e.data("isRepeatable"),s=objectGet(t,r,o?[]:{}),l=handlebarsTemplates[i];if(a=$.extend({},a||{}),e.data("keys",$.extend({},a)),s&&o){for(var d=n?1:Math.max(s.length,e.data("minItems")),c=0;c<d;c++){var f=c<s.length?s[c]:{};a[r+"Key"]=f._key||getKey();var m=$(l(a));e.append(m),loadAggregateFieldsHelper(f,m),e.find(".aggregate-holder").each(function(e,t){loadAggregateFields($(t),f,a)})}if(0==d&&e.append('<p class="js-temporary">'+e.data("emptyMessage")+"</p>"),!n){var g=dragula([e[0]],{moves:function(e,t,a){return a.classList.contains("drag-"+r)}});g.on("drag",function(){e.children(".media").addClass("shrink-for-move")}),g.on("dragend",function(){e.children(".media").removeClass("shrink-for-move")})}}else if(s){a[r+"Key"]=s._key||getKey();m=$(l(a));e.append(m),loadAggregateFieldsHelper(s,m),e.find(".aggregate-holder").each(function(e,t){loadAggregateFields($(t),s,a)})}e.data("processed","1"),e.find("[data-show-when]:not([data-show-when-processed])").attr("data-show-when-processed","1").conditionallyHide()}function loadAggregateFieldsHelper(e,t){for(var a in e){var n=e[a];if(null!==n){var i=t.find('[data-field-key="'+a+'"]');switch(i.data("fieldType")){case"file":i.find("[name$="+a+"]:checkbox").closest(".file-wrapper").addClass("has-file").find("[name$="+a+"]:checkbox").prop("checked",!0).val(n.uploadKey).parent().find(".js-file-name").html('<img class="filetype-icon" src="'+globals.adminUrl+"/assets/icon/"+n.uploadKey+'_50">'+n.name);break;case"password":i.find(".password-wrapper").addClass("has-password").find("[name$="+a+"]:checkbox").prop("checked",!0).val(n.encryptedValue);break;case"timestamp":i.find("[name$="+a+"-date]").val(n.date),i.find("[name$="+a+"-time]").val(n.time),i.find("[name$="+a+"-timezone]").val(n.timezone);break;case"markdown":i.find("[name$="+a+"]").val(n.markdown).closest(".columns").find(".markdown-html").html(n.html);break;case"checkbox":i.find("[name$="+a+"]:checkbox").prop("checked",n);break;case"boolean":i.find("[id$="+a+"-"+(n?"yes":"no")+"]").prop("checked",!0);break;case"radio":for(var r=i.find(":radio").toArray(),o=0,s=!1;o<r.length&&!s;o++){var l=$(r[o]);l.val()==n&&(s=!0,l.prop("checked",!0))}break;case"reference":var d=(Array.isArray(n)?n:[n]).filter(function(e){return!!e&&null!==e.id});i.find("[name$="+a+"]").val(d.map(function(e){return e.id}).join("|")),0<d.length&&i.find(".selection-info").html(d.map(function(e){return'<em><a href="'+i.find(".selection-info").data("baseUrl").replace(/new$/,e.id)+'?is-child=1" target="_blank">'+e._alias+"</a></em>"}).join(", "));break;case"select":if(Array.isArray(n))for(o=0;o<n.length;o++)i.find("[name$="+a+'\\[\\]] option[value="'+n[o]+'"]').prop("selected",!0);else i.find("[name$="+a+"]").val(n);i.find("[name$="+a+"\\[\\]]").trigger("change");break;default:i.find("[name$="+a+"]").val(n).trigger("change")}}}}function defaultEmptyTimezonesToBrowserValue(){$(".timezone-timestamp").each(function(e,t){var a=$(t);a.val()||a.val(Intl.DateTimeFormat().resolvedOptions().timeZone)})}function resetFormSerialization(){globals.serializedEditForm=$("#edit-form").serialize()}function transformSelectsToSelect2(){$("select.select2:not(.select2-hidden-accessible)").select2()}function loadReferences(){$(".reference-panel").each(function(e,t){var a=$(t);doInvertedSearch(a),a.find(".keywords").keyup(debounce(function(){doInvertedSearch(a)},500))})}function doInvertedSearch(a){var e=a.find(".keywords").val();$.getJSON(globals.adminUrl+"/ajax/"+a.data("type")+"/"+a.data("lookupType"),{keywords:e,itemId:globals.metaId,field:a.data("field"),invertSearch:!0},function(e){a.find(".js-select-reference").removeClass("is-loading"),a.find("tbody tr").remove();var t=handlebarsTemplates["inverted-reference-option"];a.find("tbody").append(t(e))})}function getKey(){return randString()}function objectGet(e,t,a){try{for(var n=0,i=(t=t.split(".")).length;n<i;n++)e=e[t[n]];return void 0!==e?e:a}catch(e){return a}}function hasProperty(e,t){return null!==e&&"object"===_typeof(e)&&e.hasOwnProperty(t)}function debounce(n,i,r){var o;return function(){var e=this,t=arguments,a=r&&!o;clearTimeout(o),o=setTimeout(function(){o=null,r||n.apply(e,t)},i),a&&n.apply(e,t)}}$(window).scroll(function(){clearTimeout(timer),timer=setTimeout(function(){var e=$(window).scrollTop(),t=$(".save-box").hasClass("is-pinned");initSaveBoxOffset<=e&&!t?$(".save-box").addClass("is-pinned"):e<initSaveBoxOffset&&t&&$(".save-box").removeClass("is-pinned")},50)}),$(document).ready(function(){loadHandlebarsTemplates(),$(document).find("[data-show-when]:not([data-show-when-processed])").attr("data-show-when-processed","1").conditionallyHide(),$(".edit-container").find(".aggregate-holder").each(function(e,t){var a=$(t).closest(".edit-container").data("itemId");loadAggregateFields($(t),objectGet(window,"globals.aggregates."+a,{})),$.event.trigger("aggregates-loaded")}),resetFormSerialization(),$(document).on("aggregates-loaded",resetFormSerialization),$(window).bind("beforeunload",function(){if(!globals.isSubmitting&&globals.serializedEditForm!=$("#edit-form").serialize())return"Cancel edit? Any unsaved changes will be lost."}),$("trix-editor").each(function(){this.editor.loadHTML(this.editor.element.value)}),$("#edit-tabs a").on("click",function(e){$("#edit-tabs li").removeClass("is-active"),$(e.target).closest("li").addClass("is-active");var t=$(e.target).data("tab"),a="_main"!==t;$("#edit-form").toggleClass("has-tab-selected",a),$('[name="_selectedTab"]').val(t),$(".aggregate-outer-wrapper").removeClass("is-active"),a&&$(".aggregate-outer-wrapper.tab-"+t).addClass("is-active")});var a=globals.errorMessages||{};Object.keys(a).forEach(function(e){if(/[_]/.test(e)){var t=$('[name="'+e+'"]').closest(".field");t.toggleClass("is-danger",!0),a[e].forEach(function(e){t.append('<p class="help is-danger">'+e+"</p>")})}}),0<$("#edit-tabs").length&&$(".field.is-danger").each(function(e,t){var a=$(t).closest(".is-tab");if(a.length){var n=a.attr("class").split(/\s+/);for(e=0;e<n.length;e++)/^tab-/.test(n[e])&&$('#edit-tabs [data-tab="'+n[e].replace(/^tab\-/,"")+'"]').toggleClass("is-danger",!0)}else $('#edit-tabs [data-tab="_main"]').toggleClass("is-danger",!0)}),$("#edit-form").on("click.toggle-reference-search",".js-toggle-reference-search",function(e){var t=$(e.target).closest(".reference-wrapper").find(".reference-search");$.event.trigger("toggle-laramie-modal",{modal:t}),t.data("loaded")||(t.data("loaded",!0),doSearch(t),t.find(".keywords").keyup(debounce(function(){t.find(".js-select-reference").addClass("is-loading"),doSearch(t)},500)))}),$(".js-toggle-prefs").on("click",function(e){$(e.target).toggleClass("open").closest(".card").children(".card-content").toggleClass("is-hidden");var t=$("#tags-card-content").hasClass("is-hidden")?"1":"0",a=$("#revisions-card-content").hasClass("is-hidden")?"1":"0";$.post(globals.adminUrl+"/ajax/edit-prefs",{hideTags:t,hideRevisions:a})}),$("#edit-form").on("click.clear-reference-selection",".js-clear-reference-select",function(e){$(e.target).closest(".reference-wrapper").find(":input:checked").prop("checked",!1),$(e.target).closest(".modal").find(".js-select-reference").trigger("click")}),$("#edit-form").on("keyup.update-markdown",".markdown",debounce(function(e){var t=$(e.target);t.closest(".columns").find(".markdown-html").is(":visible")&&$.post(globals.adminUrl+"/ajax/markdown",{markdown:t.val()},function(e){t.closest(".columns").find(".markdown-html").html(e.html)})},300)),$(document).on("click.preview-markdown",".js-preview-markdown",function(e){var t=$("#markdown-preview-modal").find(".content").html("Loading...").end().toggleClass("is-active"),a=$(e.target).closest(".columns").find("textarea");$.post(globals.adminUrl+"/ajax/markdown",{markdown:a.val()},function(e){t.find(".content").html(e.html)})}),$(".js-compare-revisions").on("click",function(e){return $("#revision-diff").html("Loading..."),$("#revisions-modal").toggleClass("is-active"),$.event.trigger("modal-change"),$("#revision-diff").load($(e.target).attr("href")),!1}),$(".js-hide-modal").on("click",function(){$(".modal.is-active").toggleClass("is-active",!1),$.event.trigger("modal-change")}),$("#edit-form").on("click.now-timestamp",".js-set-timestamp-now",function(e){var t=new Date,a=String(t.getFullYear()),n=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),s=[a,n,i].join("-"),l=[r,o,"00"].join(":"),d=$(e.target).closest(".field");d.find('[name$="-date"]').val(s),d.find('[name$="-time"]').val(l),d.find('[name$="-timestamp"]').val(Intl.DateTimeFormat().resolvedOptions().timeZone)}),$("#edit-form").on("click.now-timestamp",".js-clear-timestamp",function(e){var t=$(e.target).closest(".field");t.find('[name$="-date"]').val(""),t.find('[name$="-time"]').val("")}),$("#edit-form").on("click.add-aggregate",".js-add-aggregate",function(e){var t=$(e.target).parent().next(),a=t.data("keys"),n=t.children(".media").length;0<t.data("maxItems")&&n>=t.data("maxItems")?alert("You have maxed out the number of items you may add"):(loadAggregateFields(t,{},a,!0),defaultEmptyTimezonesToBrowserValue(),transformSelectsToSelect2())}),$("#edit-form").on("click.remove-aggregate",".js-remove-aggregate",function(e){var t=$(e.target),a=t.closest(".media"),n=t.closest(".aggregate-holder"),i=n.children(".media").length,r=n.data("minItems");i<=r?alert("You may not remove this item -- you must have at least "+r):(confirm("Remove this item?")&&a.remove(),0==n.children().length&&n.append('<p class="js-temporary">'+n.data("emptyMessage")+"</p>"))}),$("#edit-form").on("click.select-reference",".js-select-reference",function(e){var t=$(e.target).hasClass("is-file-select"),a=$(e.target).closest(".reference-wrapper"),n=a.find(".reference-search"),i=n.find(":input:checked").toArray(),r=a.find("input.reference-ids").val(i.map(function(e){return $(e).val()}).join("|"));t&&r.prop("checked",!0);var o="Nothing selected";0<i.length&&(o=i.map(function(e){return'<em><a href="'+a.find(".selection-info").data("baseUrl").replace(/new$/,$(e).val())+'"'+(t?' onclick="dynamicFileHref(this)"':"")+' target="_blank">'+$(e).data("label")+"</a></em>"}).join(", ")),a.toggleClass("has-file",0<i.length).toggleClass("is-checked",0<i.length).find(".selection-info").html(o),$.event.trigger("toggle-laramie-modal",{modal:n})}),$(".js-dismissable").click(function(e){$(e.target).closest(".dismissable-wrapper").hide()}),$("#edit-form").submit(function(){globals.isSubmitting=!0}),$(".js-save").click(function(){$("#edit-form").submit()}),$(".js-delete").click(function(){confirm("Delete this item?")&&$("#delete-form").submit()}),$(".js-delete-revision").click(function(e){if(confirm("Delete this revision?")){var t=$(e.target);$.post(t.attr("href"),function(e){t.closest(".revision-item").hide()})}}),$(".js-restore-revision").click(function(e){confirm("Restore this revision? Any unsaved changes will be lost.")&&$(e.target).closest(".revision-item").find(".restore-revision-form").submit()}),$("a.show-more-link").click(function(e){$(e.target).closest(".revision-history").toggleClass("show-more",!0)}),$("a.show-less-link").click(function(e){$(e.target).closest(".revision-history").toggleClass("show-more",!1)}),loadMeta(globals.metaId,function(){var e=getQS(location.search);e["highlight-comment"]&&($("#comment-"+e["highlight-comment"]).addClass("is-highlighted"),$("html, body").animate({scrollTop:$("#comment-"+e["highlight-comment"]).offset().top-300},150))}),defaultEmptyTimezonesToBrowserValue(),transformSelectsToSelect2(),loadReferences(),$(document).on("change.change-inverted-ref","select.inverted-ref",function(e){var t=$(e.target).closest(".reference-panel");$.post(globals.adminUrl+"/ajax/modify-ref/"+t.data("lookupType"),{itemId:$(e.target).data("id"),field:t.data("field"),referenceId:globals.metaId,selected:$(e.target).val()},function(e){})})});