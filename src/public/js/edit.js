var timer,handlebarsTemplates=[],wysiwygEditors={},initSaveBoxOffset=100;function getQS(e){var a={},t=(e=(e=e||"").replace("?","")).split("&");for(i=0;i<t.length;i++){var n=t[i].split("=");2==n.length&&(a[n[0]]=n[1])}return a}function dynamicFileHref(e){var a=$(e).text().trim(),t=/\.(gif|jpg|jpeg|png)$/i.test(a),i=$(e).closest("label").find("input:checkbox").val();return!!i&&($(e).attr("href",(t?globals.cropperBase:globals.fileDownloadBase)+i),!0)}function randString(e){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";e=e||10;for(var t=[],i=0;i<e;i++)t.push(a.charAt(Math.floor(Math.random()*a.length)));return t.join("")}function doSearch(t){var e=(t.closest(".reference-wrapper").find(".reference-ids").val()||"").split(/[|,]/g),a=(t.find(":input:checked").each(function(){e.push($(this).val())}),t.find(".keywords").val()),i=t.data("lookupSubtype"),n="1"==t.data("isSingleReference");$.getJSON(globals.adminUrl+"/ajax/"+t.data("type")+"/"+t.data("lookupType"),{selectedItems:e.join("|"),keywords:a,lookupSubtype:i,itemId:globals.metaId},function(e){t.find(".js-select-reference").removeClass("is-loading"),t.find(".panel-block.option").remove();var a=handlebarsTemplates["reference-"+(n?"single":"many")+"-option"];t.find(".panel-block.search").after(a(e))})}function loadHandlebarsTemplates(e){$('script[type="text/x-handlebars-template"]').each(function(){var e=$(this);handlebarsTemplates[e.attr("id")]=Handlebars.compile(e.html())})}function loadAggregateFields(e,a,t,i){if(i=!!i,e.find(".js-temporary").remove(),!i&&"1"==e.data("processed"))return!0;var n=e.data("template"),s=e.data("type"),r="1"==e.data("isRepeatable"),o=objectGet(a,s,r?[]:{}),l=handlebarsTemplates[n];if(t=$.extend({},t||{}),e.data("keys",$.extend({},t)),o&&r){for(var c=i?1:Math.max(o.length,e.data("minItems")),d=0;d<c;d++){var f=d<o.length?o[d]:{};t[s+"Key"]=f._key||getKey(),$newItem=$(l(t)),e.append($newItem),loadAggregateFieldsHelper(f,$newItem),e.find(".aggregate-holder").each(function(){loadAggregateFields($(this),f,t)})}if(0==c&&e.append('<p class="js-temporary">'+e.data("emptyMessage")+"</p>"),!i){var m=dragula([e[0]],{moves:function(e,a,t){return t.classList.contains("drag-"+s)}});m.on("drag",function(){e.children(".media").addClass("shrink-for-move")}),m.on("dragend",function(){e.children(".media").removeClass("shrink-for-move")})}}else o&&(t[s+"Key"]=o._key||getKey(),$newItem=$(l(t)),e.append($newItem),loadAggregateFieldsHelper(o,$newItem),e.find(".aggregate-holder").each(function(){loadAggregateFields($(this),o,t)}));e.data("processed","1")}function loadAggregateFieldsHelper(e,a){for(var t in e){var i=e[t],n=a.find('[data-field-key="'+t+'"]');switch(n.data("fieldType")){case"file":n.find("[name$="+t+"]:checkbox").closest(".file-wrapper").addClass("has-file").find("[name$="+t+"]:checkbox").prop("checked",!0).val(i.uploadKey).parent().find(".js-file-name").html('<img class="filetype-icon" src="'+globals.adminUrl+"/assets/icon/"+i.uploadKey+'_50">'+i.name);break;case"password":n.find(".password-wrapper").addClass("has-password").find("[name$="+t+"]:checkbox").prop("checked",!0).val(i.encryptedValue);break;case"timestamp":n.find("[name$="+t+"-date]").val(i.date),n.find("[name$="+t+"-time]").val(i.time),n.find("[name$="+t+"-timezone]").val(i.timezone);break;case"markdown":n.find("[name$="+t+"]").val(i.markdown).closest(".columns").find(".markdown-html").html(i.html);break;case"checkbox":n.find("[name$="+t+"]:checkbox").prop("checked",i);break;case"boolean":n.find("[id$="+t+"-"+(i?"yes":"no")+"]").prop("checked",!0);break;case"radio":for(var s=n.find(":radio").toArray(),r=0,o=!1;r<s.length&&!o;r++){var l=$(s[r]);l.val()==i&&(o=!0,l.prop("checked",!0))}break;case"reference":var c=(Array.isArray(i)?i:[i]).filter(function(e){return!!e&&null!==e.id});n.find("[name$="+t+"]").val(c.map(function(e){return e.id}).join("|")),0<c.length&&n.find(".selection-info").html(c.map(function(e){return'<em><a href="'+n.find(".selection-info").data("baseUrl").replace(/new$/,e.id)+'?is-child=1" target="_blank">'+e._alias+"</a></em>"}).join(", "));break;case"select":if(Array.isArray(i))for(r=0;r<i.length;r++)n.find("[name$="+t+'\\[\\]] option[value="'+i[r]+'"]').prop("selected",!0);else n.find("[name$="+t+"]").val(i);n.find("[name$="+t+"\\[\\]]").trigger("change");break;default:n.find("[name$="+t+"]").val(i).trigger("change")}}}function defaultEmptyTimezonesToBrowserValue(){$(".timezone-timestamp").each(function(){$timezone=$(this),$timezone.val()||$timezone.val(Intl.DateTimeFormat().resolvedOptions().timeZone)})}function transformSelectsToSelect2(){$("select[multiple]:not(.select2-hidden-accessible), select.select2:not(.select2-hidden-accessible)").select2()}function getKey(){return randString()}function objectGet(e,a,t){try{for(var i=0,n=(a=a.split(".")).length;i<n;i++)e=e[a[i]];return void 0!==e?e:t}catch(e){return t}}function hasProperty(e,a){return null!==e&&"object"==typeof e&&e.hasOwnProperty(a)}function debounce(i,n,s){var r;return function(){var e=this,a=arguments,t=s&&!r;clearTimeout(r),r=setTimeout(function(){r=null,s||i.apply(e,a)},n),t&&i.apply(e,a)}}$(window).scroll(function(){clearTimeout(timer),timer=setTimeout(function(){var e=$(window).scrollTop(),a=$(".save-box").hasClass("is-pinned");initSaveBoxOffset<=e&&!a?$(".save-box").addClass("is-pinned"):e<initSaveBoxOffset&&a&&$(".save-box").removeClass("is-pinned")},50)}),$(document).ready(function(){loadHandlebarsTemplates(),$("#edit-form").find(".aggregate-holder").each(function(){loadAggregateFields($(this),objectGet(window,"globals.aggregates",{}))}),$("trix-editor").each(function(){this.editor.loadHTML(this.editor.element.value)}),$("#edit-tabs a").on("click",function(){$("#edit-tabs li").removeClass("is-active"),$(this).closest("li").addClass("is-active");var e=$(this).data("tab"),a="_main"!==e;$("#edit-form").toggleClass("has-tab-selected",a),$('[name="_selectedTab"]').val(e),$(".aggregate-outer-wrapper").removeClass("is-active"),a&&$(".aggregate-outer-wrapper.tab-"+e).addClass("is-active")});var t=globals.errorMessages||{};Object.keys(t).forEach(function(e){if(/[_]/.test(e)){var a=$('[name="'+e+'"]').closest(".field");a.toggleClass("is-danger",!0),t[e].forEach(function(e){a.append('<p class="help is-danger">'+e+"</p>")})}}),0<$("#edit-tabs").length&&$(".field.is-danger").each(function(){var e=$(this).closest(".is-tab");if(e.length)for(var a=e.attr("class").split(/\s+/),t=0;t<a.length;t++)/^tab-/.test(a[t])&&$('#edit-tabs [data-tab="'+a[t].replace(/^tab\-/,"")+'"]').toggleClass("is-danger",!0);else $('#edit-tabs [data-tab="_main"]').toggleClass("is-danger",!0)}),$("#edit-form").on("click.toggle-reference-search",".js-toggle-reference-search",function(){$searchWrapper=$(this).closest(".reference-wrapper").find(".reference-search"),$searchWrapper.toggle(),$searchWrapper.data("loaded")||($searchWrapper.data("loaded",!0),doSearch($searchWrapper),$searchWrapper.find(".keywords").keyup(debounce(function(){$searchWrapper.find(".js-select-reference").addClass("is-loading"),doSearch($searchWrapper)},500)))}),$(".js-toggle-prefs").on("click",function(){$(this).toggleClass("open").closest(".card").children(".card-content").toggleClass("is-hidden");var e=$("#tags-card-content").hasClass("is-hidden")?"1":"0",a=$("#revisions-card-content").hasClass("is-hidden")?"1":"0";$.post(globals.adminUrl+"/ajax/edit-prefs",{hideTags:e,hideRevisions:a})}),$("#edit-form").on("click.clear-reference-selection",".js-clear-reference-select",function(){$(this).closest(".reference-wrapper").find(":input:checked").prop("checked",!1),$(this).parent().find(".js-select-reference").trigger("click")}),$("#edit-form").on("keyup.update-markdown",".markdown",debounce(function(){var a=$(this);$.post(globals.adminUrl+"/ajax/markdown",{markdown:a.val()},function(e){a.closest(".columns").find(".markdown-html").html(e.html)})},300)),$(".js-compare-revisions").on("click",function(){return $("#revision-diff").html("Loading..."),$(".modal").toggleClass("is-active"),$.event.trigger("modal-change"),$("#revision-diff").load($(this).attr("href")),!1}),$(".js-hide-modal").on("click",function(){$(".modal").toggleClass("is-active",!1),$.event.trigger("modal-change")}),$("#edit-form").on("click.now-timestamp",".js-set-timestamp-now",function(e){var a=new Date,t=String(a.getFullYear()),i=String(a.getMonth()+1).padStart(2,"0"),n=String(a.getDate()).padStart(2,"0"),s=String(a.getHours()).padStart(2,"0"),r=String(a.getMinutes()).padStart(2,"0"),o=[t,i,n].join("-"),l=[s,r,"00"].join(":");$field=$(this).closest(".field"),$field.find('[name$="-date"]').val(o),$field.find('[name$="-time"]').val(l),$field.find('[name$="-timestamp"]').val(Intl.DateTimeFormat().resolvedOptions().timeZone)}),$("#edit-form").on("click.now-timestamp",".js-clear-timestamp",function(e){$field=$(this).closest(".field"),$field.find('[name$="-date"]').val(""),$field.find('[name$="-time"]').val("")}),$("#edit-form").on("click.add-aggregate",".js-add-aggregate",function(e){var a=$(e.target).parent().next(),t=a.data("keys"),i=a.children(".media").length;0<a.data("maxItems")&&i>=a.data("maxItems")?alert("You have maxed out the number of items you may add"):(loadAggregateFields(a,{},t,!0),defaultEmptyTimezonesToBrowserValue(),transformSelectsToSelect2())}),$("#edit-form").on("click.remove-aggregate",".js-remove-aggregate",function(e){var a=$(e.target),t=a.closest(".media"),i=a.closest(".aggregate-holder"),n=i.children(".media").length,s=i.data("minItems");n<=s?alert("You may not remove this item -- you must have at least "+s):(confirm("Remove this item?")&&t.remove(),0==i.children().length&&i.append('<p class="js-temporary">'+i.data("emptyMessage")+"</p>"))}),$("#edit-form").on("click.select-reference",".js-select-reference",function(){var a=$(this).hasClass("is-file-select"),t=$(this).closest(".reference-wrapper"),e=t.find(".reference-search"),i=e.find(":input:checked").toArray(),n=t.find("input.reference-ids").val(i.map(function(e){return $(e).val()}).join("|"));a&&n.prop("checked",!0);var s="Nothing selected";0<i.length&&(s=i.map(function(e){return'<em><a href="'+t.find(".selection-info").data("baseUrl").replace(/new$/,$(e).val())+'"'+(a?' onclick="dynamicFileHref(this)"':"")+' target="_blank">'+$(e).data("label")+"</a></em>"}).join(", ")),t.toggleClass("has-file",0<i.length).find(".selection-info").html(s).end().find(".hide-when-file").hide(),e.toggle(!1)}),$(".js-dismissable").click(function(){$(this).closest(".dismissable-wrapper").hide()}),$(".js-save").click(function(){$("#edit-form").submit()}),$(".js-cancel-edit").click(function(){return confirm("Cancel edit? Any unsaved changes will be lost.")}),$(".js-delete").click(function(){confirm("Delete this item?")&&$("#delete-form").submit()}),$(".js-delete-revision").click(function(){confirm("Delete this revision?")&&($link=$(this),$.post($link.attr("href"),function(e){$link.closest(".revision-item").hide()}))}),$(".js-restore-revision").click(function(){confirm("Restore this revision? Any unsaved changes will be lost.")&&$(this).closest(".revision-item").find(".restore-revision-form").submit()}),$("a.show-more-link").click(function(){$(this).closest(".revision-history").toggleClass("show-more",!0)}),$("a.show-less-link").click(function(){$(this).closest(".revision-history").toggleClass("show-more",!1)}),loadMeta(globals.metaId,function(){var e=getQS(location.search);e["highlight-comment"]&&($("#comment-"+e["highlight-comment"]).addClass("is-highlighted"),$("html, body").animate({scrollTop:$("#comment-"+e["highlight-comment"]).offset().top-300},150))}),defaultEmptyTimezonesToBrowserValue(),transformSelectsToSelect2()});